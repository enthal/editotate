<!DOCTYPE html>
<html>
  <head>
    <title>Editotate!</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.0/lodash.min.js" charset="utf-8"></script>

  </head>

  <body>
    <div id='editable' contentEditable="true">
      Loading...
    </div>
    <div id='data1'> Fetching.... </div>
    <div id='data2'> Fetching.... </div>

    <script>
      var editable = document.getElementById('editable');

      editable.addEventListener('input', function () {  // only on WebKit (TODO)
        var sel = window.getSelection();

        var node = sel.focusNode;
        var r = /\b(\w+)(\W)$/ .exec( node.nodeValue.substring(0, sel.focusOffset) );
        if (r) {
          var word = r[1], terminal = r[2];
          var replacement = {
            red: 'vermillion',
            green: 'chartreuse',
            blue: 'azure',
          }[word];

          console.log(word, '['+terminal+']', replacement);

          if (replacement) {
            // replace "red" with "vermillion", etc

            console.log(sel);
            var origOffset = sel.focusOffset;
            var nv = node.nodeValue;

            var insertBeforeFocusNode = function(newNode) {
              node.parentElement.insertBefore(newNode, node);
            }
            var prefixNode = document.createTextNode(nv.substring(0, sel.focusOffset - 1 - word.length));
            insertBeforeFocusNode(prefixNode);

            var tempElem = document.createElement("span");
            insertBeforeFocusNode(tempElem);
            tempElem.insertAdjacentHTML( 'beforebegin',
              "<span style='color:"+word+"' contenteditable='false'>"+replacement+"</span>" );
            node.parentElement.removeChild(tempElem);

            var suffixNode = document.createTextNode(nv.substring(sel.focusOffset - 1));
            insertBeforeFocusNode(suffixNode);

            node.parentElement.removeChild(node);

            // move caret back to expected location
            var range = document.createRange();
            range.setStart(suffixNode, 1);  // just after terminal character: where we started, from user perspective
            range.collapse(true);
            sel.removeAllRanges();
            sel.addRange(range);
          }
        }

        localStorage.setItem('contenteditable', this.innerHTML);
        localStorage.setItem('count', +(localStorage.getItem('count')||0) + 1);
      });

      editable.innerHTML = localStorage.getItem('contenteditable') || "You can edit this text!";

      d3.csv("https://www.quandl.com/api/v1/datasets/WIKI/AAPL.csv?trim_start=2015-07-01&rows=1")
        .get(function(error, rows) {
          if (error) { throw error; }
          d3.select('#data1').text(rows[0]['Adj. Close']);
          console.log(rows);
        });

    </script>
  </body>
</html>
